#! /usr/bin/env perl

=head1 NAME

pack - Utility to create sprite sheets

=head1 SYNOPSIS

pack sheet *.png *.jpg 

=head1 INSTALLATION

One of the following will work to get dependencies:

=over 4

=item apt-get

sudo apt-get install perlmagick

=item CPAN

cpan Image::Magic

=back

=head1 AUTHOR

Bruce Armstrong bruce@fortressofgeekdom.org

=cut

use strict;
use warnings;
use Image::Magick;

sub pack_sheet {
    my @images = sort { $a->Get('height') <=> $b->Get('height') } read_images();
    my $size;
    for my $i (@images) {
        $size += $i->Get('height') * $i->Get('width');
    }

    my $width = 16;
    while ( $width**2 < $size ) {
        $width *= 2;
    }

    while (1) {
        eval {
            pack_images( $width, \@images );
            last;
        };
        $width *= 2;
    }
}

sub read_images {
    my @images;
    for my $file (@ARGV) {
        eval {
            my $image = Image::Magick->new;
            $image->Read($file);
            push @images, $image;
        };
        print "Error: $@\n" if $@;
    }
}

sub pack_images {
    my ( $width, $images ) = @_;
    my @space = [ { h => $width, w => $width, full => 0 } ];
    for my $i (@$images) {
        for my $y (0 .. $#space) {
			for my $x (0 .. $#{ $space[$y] }) {
				goto FOUND if place($i, $x, $y, \@space);
			}
		}
		die "Can't place image\n";
		FOUND:
    }
}

sub place {
	my ($image, $x, $y, $space) = @_;
	my ($dx, $dy) = ($x, $y);
	my ($w, $h) = $image->Get('width', 'height');
	my ($aw, $ah) = 0, 0;
	while ($aw < $w) {
		my $cell = $space->[$dx][$dy++];
		return () if $cell->{full};
		$w += $cell->{w};
	}
	while ($ah < $h) {
		my $cell = $space->[$dx++][$dy];
		return () if $cell->{full};
		$w += $cell->{h};
	}
	for my $row_id ( $y .. --$dy ) {
		my $row = $space->[$row_id];
		for my $col_id ( $x .. --$dx ) {
			my $cell = $row->[$col_id];
			$cell->{full} = 1;
		}
	}
	if ($aw > $w) {
		for my $row (@$space) {
		
		}
	}
}

pack_sheet();
